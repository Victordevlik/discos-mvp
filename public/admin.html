<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel Admin</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="card">
    <h2>Panel Admin</h2>
    <!-- Clave ADMIN_SECRET requerida para todas las acciones -->
    <div class="row">
      <label>Clave admin</label>
      <input id="admin-secret" type="password" placeholder="ADMIN_SECRET">
      <button id="btn-load">Cargar venues</button>
    </div>
    <div id="error" class="error"></div>
    <div id="modal" class="modal">
      <div class="modal-inner">
        <div id="modal-text"></div>
        <div class="row">
          <button id="modal-close">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <h3>Locales</h3>
    <!-- Lista simple de venues con botón +1 noche -->
    <div id="venues-list"></div>
  </div>
  <div class="card">
    <h3>Agregar crédito</h3>
    <div class="row">
      <input id="venue-new-id" type="text" placeholder="venueId">
      <input id="venue-new-amount" type="number" min="1" value="1" placeholder="cantidad">
      <button id="btn-add-credit">Agregar crédito</button>
    </div>
  </div>
  <script>
    // Fetch con manejo de JSON
    async function api(path, { method = 'GET', headers = {}, body } = {}) {
      const res = await fetch(path, {
        method,
        headers: Object.assign({ 'Content-Type': 'application/json' }, headers),
        body
      })
      const text = await res.text()
      let j = null
      try { j = JSON.parse(text) } catch { j = { raw: text } }
      if (!res.ok) throw new Error(j && j.error ? j.error : ('HTTP ' + res.status))
      return j
    }
    function showError(msg) {
      if (!msg) return
      const m = document.getElementById('modal')
      const t = document.getElementById('modal-text')
      const tt = document.getElementById('modal-title')
      if (!m || !t) return
      m.classList.remove('type-error','type-info','type-success')
      m.classList.add('type-error')
      if (tt) tt.textContent = 'Error'
      t.textContent = msg || ''
      m.classList.add('show')
    }
    async function loadVenues() {
      showError('')
      const secret = document.getElementById('admin-secret').value.trim()
      if (!secret) { showError('Ingresa clave admin'); return }
      // La clave se envía por query o header; aquí usamos query para GET
      const r = await api('/api/admin/venues?admin_secret=' + encodeURIComponent(secret))
      const container = document.getElementById('venues-list')
      container.innerHTML = ''
      if (!r.venues || !r.venues.length) {
        container.textContent = 'No hay locales. Usa “Agregar crédito” para crear uno.'
      }
      for (const v of r.venues || []) {
        const row = document.createElement('div')
        row.className = 'row'
        const info = document.createElement('div')
        info.textContent = `${v.name} (${v.venueId}) • créditos: ${v.credits} • activo: ${v.active ? 'sí' : 'no'} • PIN: ${v.pin ? v.pin : '-'} • Email: ${v.email ? v.email : '-'}`
        const url = `${location.origin}/?venueId=${encodeURIComponent(v.venueId)}`
        const link = document.createElement('a')
        link.href = url
        link.target = '_blank'
        link.rel = 'noopener'
        link.textContent = url
        const btn = document.createElement('button')
        btn.textContent = '+1 noche'
        btn.onclick = async () => {
          try {
            // Para POST enviamos la clave por header
            await api('/api/admin/venues/credit', {
              method: 'POST',
              headers: { 'X-Admin-Secret': secret },
              body: JSON.stringify({ venueId: v.venueId, amount: 1 })
            })
            await loadVenues()
          } catch (e) { showError(String(e.message)) }
        }
        const pinInput = document.createElement('input')
        pinInput.type = 'password'
        pinInput.placeholder = 'PIN (4 dígitos)'
        const pinBtn = document.createElement('button')
        pinBtn.textContent = 'Guardar PIN'
        pinBtn.onclick = async () => {
          try {
            const pin = pinInput.value.trim()
            if (!pin) { showError('Ingresa un PIN'); return }
            await api('/api/admin/venues/pin', {
              method: 'POST',
              headers: { 'X-Admin-Secret': secret },
              body: JSON.stringify({ venueId: v.venueId, pin })
            })
            await loadVenues()
          } catch (e) { showError(String(e.message)) }
        }
        const emailInput = document.createElement('input')
        emailInput.type = 'email'
        emailInput.placeholder = 'Email del venue'
        const emailBtn = document.createElement('button')
        emailBtn.textContent = 'Guardar email'
        emailBtn.onclick = async () => {
          try {
            const email = emailInput.value.trim()
            if (!email) { showError('Ingresa un email'); return }
            await api('/api/admin/venues/email', {
              method: 'POST',
              headers: { 'X-Admin-Secret': secret },
              body: JSON.stringify({ venueId: v.venueId, email })
            })
            await loadVenues()
          } catch (e) { showError(String(e.message)) }
        }
        const delBtn = document.createElement('button')
        delBtn.textContent = 'Eliminar'
        delBtn.onclick = async () => {
          try {
            const ok = confirm(`¿Eliminar el local "${v.name}" (${v.venueId})?`)
            if (!ok) return
            await api('/api/admin/venues/delete', {
              method: 'POST',
              headers: { 'X-Admin-Secret': secret },
              body: JSON.stringify({ venueId: v.venueId })
            })
            await loadVenues()
          } catch (e) { showError(String(e.message)) }
        }
        const col = document.createElement('div')
        col.appendChild(info)
        col.appendChild(link)
        col.appendChild(pinInput)
        col.appendChild(pinBtn)
        col.appendChild(emailInput)
        col.appendChild(emailBtn)
        col.appendChild(delBtn)
        row.appendChild(col)
        row.appendChild(btn)
        container.appendChild(row)
      }
    }
    document.getElementById('btn-load').onclick = () => loadVenues().catch(e => showError(String(e.message)))
    document.getElementById('modal-close').onclick = () => { const m = document.getElementById('modal'); if (m) m.classList.remove('show') }
    document.getElementById('modal').onclick = (e) => { if (e.target && e.target.id === 'modal') { const m = document.getElementById('modal'); if (m) m.classList.remove('show') } }
    document.getElementById('btn-add-credit').onclick = async () => {
      showError('')
      const secret = document.getElementById('admin-secret').value.trim()
      const venueId = document.getElementById('venue-new-id').value.trim()
      const amountStr = document.getElementById('venue-new-amount').value
      const amount = Math.max(1, Number(amountStr || 1))
      if (!secret) { showError('Ingresa clave admin'); return }
      if (!venueId) { showError('Ingresa un venueId'); return }
      try {
        await api('/api/admin/venues/credit', {
          method: 'POST',
          headers: { 'X-Admin-Secret': secret },
          body: JSON.stringify({ venueId, amount })
        })
        await loadVenues()
      } catch (e) { showError(String(e.message)) }
    }
  </script>
</body>
</html>
